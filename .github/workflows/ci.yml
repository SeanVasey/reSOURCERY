name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: JavaScript syntax check
        run: |
          node --check js/version.js
          node --check js/fft.js
          node --check js/tempo-detector.js
          node --check js/key-detector.js
          node --check js/analysis-worker.js
          node --check js/audio-processor.js
          node --check js/app.js
          node --check sw.js
          node --check api/fetch.js

      - name: Repository baseline smoke checks
        run: |
          test -f README.md
          test -f CHANGELOG.md
          test -f LICENSE
          test -f SECURITY.md
          test -f CLAUDE.md
          test -f .editorconfig
          test -f index.html
          test -f vercel.json
          test -f manifest.json
          test -f css/styles.css
          test -f js/app.js
          test -f js/audio-processor.js
          test -f js/version.js
          test -f sw.js
          test -f api/fetch.js
          test -f docs/MANIFEST.md

      - name: Version consistency check
        run: |
          VERSION=$(node -e "
            const fs = require('fs');
            const src = fs.readFileSync('js/version.js', 'utf8');
            const m = src.match(/major:\s*(\d+)[\s\S]*?minor:\s*(\d+)[\s\S]*?patch:\s*(\d+)/);
            console.log('resourcery-v' + m[1] + '.' + m[2] + '.' + m[3]);
          ")
          FALLBACK=$(grep -oP "resourcery-v[\d.]+" sw.js | head -1)
          echo "version.js cacheKey: $VERSION"
          echo "sw.js fallback: $FALLBACK"
          test "$VERSION" = "$FALLBACK" || { echo "ERROR: sw.js fallback cache name does not match version.js cacheKey"; exit 1; }
